<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZipHQ Analytics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .stat-card:hover { transform: translateY(-2px); transition: transform 0.2s; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 p-6">
  <div class="max-w-7xl mx-auto">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">ZipHQ Analytics Dashboard</h1>
      <p class="text-gray-600">Real-time procurement analytics and insights</p>
    </div>

    <div class="mb-6 border-b border-gray-200">
      <nav class="-mb-px flex space-x-8">
        <button onclick="showTab('invoices')" id="tab-invoices" class="tab-btn border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600">Invoices</button>
        <button onclick="showTab('metrics')" id="tab-metrics" class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">Metrics</button>
        <button onclick="showTab('vendors')" id="tab-vendors" class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">Vendor Spend</button>
      </nav>
    </div>

    <div id="content-invoices" class="tab-content">
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex flex-wrap gap-4 items-end">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
            <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="">All Statuses</option>
              <option value="PENDING_APPROVAL">Pending Approval</option>
              <option value="APPROVED">Approved</option>
              <option value="INITIAL">Initial</option>
              <option value="PAID">Paid</option>
            </select>
          </div>
          <div class="w-32">
            <label class="block text-sm font-medium text-gray-700 mb-2">Per Page</label>
            <select id="pageSize" class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="20" selected>20</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
          <button id="fetchBtn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">Fetch Invoices</button>
        </div>
        <div id="invStats" class="mt-4 pt-4 border-t hidden"><p class="text-sm text-gray-600"></p></div>
      </div>
      <div id="invLoading" class="bg-white rounded-lg shadow p-12 text-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-600">Loading...</p>
      </div>
      <div id="invTable" class="bg-white rounded-lg shadow overflow-hidden hidden">
        <table class="w-full">
          <thead class="bg-gray-50 border-b">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Invoice #</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Department</th>
            </tr>
          </thead>
          <tbody id="invBody" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <div id="content-metrics" class="tab-content hidden">
      <button id="fetchMetrics" class="mb-6 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">Load All Metrics (Since Feb 1, 2025)</button>
      <div id="metLoading" class="bg-white rounded-lg shadow p-12 text-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p id="metLoadText" class="text-gray-600">Fetching invoices...</p>
        <p id="metProgress" class="text-sm text-gray-500 mt-2"></p>
      </div>
      <div id="metContent" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
          <div class="stat-card bg-white rounded-lg shadow p-6">
            <p class="text-sm font-medium text-gray-600">Total Invoices</p>
            <p id="metTotal" class="text-3xl font-bold text-gray-900 mt-2">0</p>
            <p class="text-xs text-gray-500 mt-1">Since Feb 1, 2025</p>
          </div>
          <div class="stat-card bg-white rounded-lg shadow p-6">
            <p class="text-sm font-medium text-gray-600">Avg Coding Time</p>
            <p id="metAvgTime" class="text-3xl font-bold text-gray-900 mt-2">-</p>
            <p class="text-xs text-gray-500 mt-1">days</p>
          </div>
          <div class="stat-card bg-white rounded-lg shadow p-6">
            <p class="text-sm font-medium text-gray-600">Pending Approval</p>
            <p id="metPending" class="text-3xl font-bold text-gray-900 mt-2">0</p>
          </div>
          <div class="stat-card bg-white rounded-lg shadow p-6">
            <p class="text-sm font-medium text-gray-600">Total Spend</p>
            <p id="metSpend" class="text-3xl font-bold text-gray-900 mt-2">$0</p>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Invoices by Status</h3>
            <canvas id="statusChart"></canvas>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Coding Time Distribution</h3>
            <canvas id="timeChart"></canvas>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Top 10 Departments by Spend</h3>
            <canvas id="deptChart"></canvas>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Invoices by Coder</h3>
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Coder</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Invoices</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Avg Days</th>
                </tr>
              </thead>
              <tbody id="coderTable" class="divide-y"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="content-vendors" class="tab-content hidden">
      <button id="fetchVendors" class="mb-6 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">Load Vendor Spend</button>
      <div id="vendContent" class="hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-4">Top 20 Vendors by Spend</h3>
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Rank</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Vendor</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Total Spend</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Invoices</th>
              </tr>
            </thead>
            <tbody id="vendTable" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = 'https://ziphq-middleware-connector-production.up.railway.app/api';
    const TOKEN = 'db590f86e8119131dfdfa2ac42552a3bd371c3f83f8935a8eed400e64a7ad810';
    const FEB_1_2025 = new Date('2025-02-01').getTime();
    let charts = {};

    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('border-blue-500', 'text-blue-600');
        el.classList.add('border-transparent', 'text-gray-500');
      });
      document.getElementById('content-' + tab).classList.remove('hidden');
      const btn = document.getElementById('tab-' + tab);
      btn.classList.remove('border-transparent', 'text-gray-500');
      btn.classList.add('border-blue-500', 'text-blue-600');
    }

    function getInvoiceDate(inv) {
      // Check multiple date fields in priority order
      return inv.receipt_date || inv.invoice_date || inv.created_at || inv.received_at;
    }

    function getCodedDate(inv) {
      return inv.coded_at || inv.coded_date;
    }

    function isAfterFeb2025(inv) {
      const dateStr = getInvoiceDate(inv);
      if (!dateStr) return false;
      const d = new Date(dateStr).getTime();
      return d >= FEB_1_2025;
    }

    function fmt(n, c = 'USD') {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: c }).format(n || 0);
    }

    function fmtDate(d) {
      if (!d) return 'N/A';
      return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function badge(s) {
      const colors = {
        'PENDING_APPROVAL': 'bg-yellow-100 text-yellow-800',
        'APPROVED': 'bg-green-100 text-green-800',
        'INITIAL': 'bg-blue-100 text-blue-800',
        'PAID': 'bg-emerald-100 text-emerald-800',
        'ARCHIVED': 'bg-gray-100 text-gray-800'
      };
      return '<span class="px-2 py-1 text-xs font-medium rounded-full ' + (colors[s] || 'bg-gray-100 text-gray-800') + '">' + (s || '').replace(/_/g, ' ') + '</span>';
    }

    async function fetchPage(url) {
      const r = await fetch(url, { headers: { 'Authorization': 'Bearer ' + TOKEN, 'Accept': 'application/json' } });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    }

    async function fetchAllInvoices(onProgress) {
      let all = [];
      let token = null;
      let page = 0;
      do {
        page++;
        if (onProgress) onProgress(page, all.length);
        let url = API + '/invoices?page_size=100' + (token ? '&page_token=' + encodeURIComponent(token) : '');
        const data = await fetchPage(url);
        const list = data.data?.list || [];
        all.push(...list);
        token = data.data?.pagination?.next_page_token;
      } while (token);
      return all;
    }

    document.getElementById('fetchBtn').onclick = async function() {
      document.getElementById('invLoading').classList.remove('hidden');
      document.getElementById('invTable').classList.add('hidden');
      try {
        const status = document.getElementById('statusFilter').value;
        const size = document.getElementById('pageSize').value;
        let url = API + '/invoices?page_size=' + size + (status ? '&status=' + status : '');
        const data = await fetchPage(url);
        const invs = data.data?.list || [];
        const total = data.data?.pagination?.total || 0;

        document.getElementById('invStats').classList.remove('hidden');
        document.getElementById('invStats').querySelector('p').textContent = 'Showing ' + invs.length + ' of ' + total.toLocaleString() + ' total invoices';

        document.getElementById('invBody').innerHTML = invs.map(i => 
          '<tr class="hover:bg-gray-50">' +
          '<td class="px-4 py-3 text-sm font-medium">' + (i.invoice_number || i.invoice_id || '-') + '</td>' +
          '<td class="px-4 py-3 text-sm">' + (i.vendor?.name || 'N/A') + '</td>' +
          '<td class="px-4 py-3 text-sm font-semibold">' + fmt(i.amount, i.currency) + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-600">' + fmtDate(getInvoiceDate(i)) + '</td>' +
          '<td class="px-4 py-3 text-sm">' + badge(i.status) + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-600">' + (i.department?.name || 'N/A') + '</td>' +
          '</tr>'
        ).join('');

        document.getElementById('invTable').classList.remove('hidden');
      } catch(e) {
        alert('Error: ' + e.message);
      }
      document.getElementById('invLoading').classList.add('hidden');
    };

    document.getElementById('fetchMetrics').onclick = async function() {
      document.getElementById('metLoading').classList.remove('hidden');
      document.getElementById('metContent').classList.add('hidden');
      try {
        const all = await fetchAllInvoices((p, count) => {
          document.getElementById('metLoadText').textContent = 'Fetching page ' + p + '...';
          document.getElementById('metProgress').textContent = 'Loaded ' + count + ' invoices';
        });

        // Filter invoices since Feb 1, 2025
        const filtered = all.filter(i => isAfterFeb2025(i));

        console.log('Total invoices fetched:', all.length);
        console.log('Filtered since Feb 1, 2025:', filtered.length);

        document.getElementById('metTotal').textContent = filtered.length.toLocaleString();
        document.getElementById('metPending').textContent = filtered.filter(i => i.status === 'PENDING_APPROVAL').length;

        const totalSpend = filtered.reduce((sum, i) => sum + (parseFloat(i.amount) || 0), 0);
        document.getElementById('metSpend').textContent = fmt(totalSpend);

        // Calculate coding time: receipt_date to coded_date
        const coded = filtered.filter(i => {
          const receiptDate = i.receipt_date || i.received_at || i.created_at;
          const codedDate = getCodedDate(i);
          return receiptDate && codedDate;
        });

        if (coded.length > 0) {
          const avgDays = coded.reduce((sum, i) => {
            const receiptDate = i.receipt_date || i.received_at || i.created_at;
            const codedDate = getCodedDate(i);
            const days = (new Date(codedDate).getTime() - new Date(receiptDate).getTime()) / (1000 * 60 * 60 * 24);
            return sum + days;
          }, 0) / coded.length;
          document.getElementById('metAvgTime').textContent = avgDays.toFixed(1);
        } else {
          document.getElementById('metAvgTime').textContent = 'N/A';
        }

        // Status chart
        const statusCount = {};
        filtered.forEach(i => {
          const s = i.status || 'UNKNOWN';
          statusCount[s] = (statusCount[s] || 0) + 1;
        });
        if (charts.status) charts.status.destroy();
        charts.status = new Chart(document.getElementById('statusChart'), {
          type: 'bar',
          data: {
            labels: Object.keys(statusCount),
            datasets: [{ data: Object.values(statusCount), backgroundColor: 'rgba(59, 130, 246, 0.5)' }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });

        // Time distribution
        const buckets = { '<7d': 0, '7-14d': 0, '>14d': 0 };
        coded.forEach(i => {
          const receiptDate = i.receipt_date || i.received_at || i.created_at;
          const codedDate = getCodedDate(i);
          const days = (new Date(codedDate).getTime() - new Date(receiptDate).getTime()) / (1000 * 60 * 60 * 24);
          if (days < 7) buckets['<7d']++;
          else if (days <= 14) buckets['7-14d']++;
          else buckets['>14d']++;
        });
        if (charts.time) charts.time.destroy();
        charts.time = new Chart(document.getElementById('timeChart'), {
          type: 'pie',
          data: {
            labels: Object.keys(buckets),
            datasets: [{ data: Object.values(buckets), backgroundColor: ['#22c55e', '#eab308', '#ef4444'] }]
          }
        });

        // Dept spend
        const deptSpend = {};
        filtered.forEach(i => {
          const d = i.department?.name || 'Unknown';
          deptSpend[d] = (deptSpend[d] || 0) + (parseFloat(i.amount) || 0);
        });
        const topDepts = Object.entries(deptSpend).sort((a, b) => b[1] - a[1]).slice(0, 10);
        if (charts.dept) charts.dept.destroy();
        charts.dept = new Chart(document.getElementById('deptChart'), {
          type: 'bar',
          data: {
            labels: topDepts.map(e => e[0]),
            datasets: [{ data: topDepts.map(e => e[1]), backgroundColor: 'rgba(34, 197, 94, 0.5)' }]
          },
          options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
        });

        // Coders: Look for coded_by field
        const coderStats = {};
        filtered.forEach(i => {
          if (i.coded_by && i.coded_by.name) {
            const coder = i.coded_by.name;
            if (!coderStats[coder]) coderStats[coder] = { count: 0, totalDays: 0 };
            coderStats[coder].count++;

            const receiptDate = i.receipt_date || i.received_at || i.created_at;
            const codedDate = getCodedDate(i);
            if (receiptDate && codedDate) {
              const days = (new Date(codedDate).getTime() - new Date(receiptDate).getTime()) / (1000 * 60 * 60 * 24);
              coderStats[coder].totalDays += days;
            }
          }
        });

        if (Object.keys(coderStats).length > 0) {
          const sorted = Object.entries(coderStats).map(([name, stats]) => ({
            name,
            count: stats.count,
            avgDays: stats.count > 0 ? (stats.totalDays / stats.count).toFixed(1) : 'N/A'
          })).sort((a, b) => b.count - a.count);

          document.getElementById('coderTable').innerHTML = sorted.map(c => 
            '<tr><td class="px-4 py-3 text-sm">' + c.name + '</td>' +
            '<td class="px-4 py-3 text-sm font-semibold">' + c.count + '</td>' +
            '<td class="px-4 py-3 text-sm">' + c.avgDays + '</td></tr>'
          ).join('');
        } else {
          document.getElementById('coderTable').innerHTML = 
            '<tr><td colspan="3" class="px-4 py-3 text-sm text-gray-500">No coder data available (coded_by field not found in API)</td></tr>';
        }

        document.getElementById('metContent').classList.remove('hidden');
      } catch(e) {
        alert('Error loading metrics: ' + e.message);
        console.error(e);
      }
      document.getElementById('metLoading').classList.add('hidden');
    };

    document.getElementById('fetchVendors').onclick = async function() {
      const all = await fetchAllInvoices();
      const filtered = all.filter(i => isAfterFeb2025(i));
      const vendSpend = {};
      const vendCount = {};
      filtered.forEach(i => {
        const v = i.vendor?.name || 'Unknown';
        vendSpend[v] = (vendSpend[v] || 0) + (parseFloat(i.amount) || 0);
        vendCount[v] = (vendCount[v] || 0) + 1;
      });
      const top = Object.entries(vendSpend).sort((a, b) => b[1] - a[1]).slice(0, 20);
      document.getElementById('vendTable').innerHTML = top.map((e, i) => 
        '<tr><td class="px-4 py-3 text-sm font-medium">' + (i + 1) + '</td>' +
        '<td class="px-4 py-3 text-sm">' + e[0] + '</td>' +
        '<td class="px-4 py-3 text-sm font-semibold">' + fmt(e[1]) + '</td>' +
        '<td class="px-4 py-3 text-sm">' + vendCount[e[0]] + '</td></tr>'
      ).join('');
      document.getElementById('vendContent').classList.remove('hidden');
    };
  </script>
</body>
</html>